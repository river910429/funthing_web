<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8"/>
    <title>æ•™å¸«è¨»å†Š</title>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <style>
      body {
        margin: 0; padding: 0; height: 100vh; width: 100vw;
        display: flex; align-items: center; justify-content: center;
        background: url("{{ url_for('static', filename='Font/1x/ALL_BG_LOG_IN_STUDENT.png') }}")
                    no-repeat center center fixed;
        background-color: #f0f2f5;
        background-size: cover;
        font-family: system-ui, -apple-system, "Noto Sans TC", Arial;
      }
      .card {
        background: rgba(255,255,255,0.95);
        border-radius: 16px; padding: 30px 40px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        max-width: 520px; width: 90%;
        position: relative;
        overflow: visible;
        z-index: 10;
      }
      h2 { text-align: center; margin-bottom: 20px; color: #333; }
      form { display: grid; gap: 15px; }
      label { font-weight: 600; color: #222; font-size: 0.95rem; margin-bottom: 4px; display: block; }
      small { color:#666; font-size: 0.85rem; }
      
      input {
        padding: 12px; width: 100%; box-sizing: border-box;
        border: 1px solid #ccc; border-radius: 8px; font-size: 1rem;
        transition: border 0.2s;
      }
      input:focus { border-color: #1976d2; outline: none; box-shadow: 0 0 0 2px rgba(25,118,210,0.1); }

      input.error { border-color: #d32f2f; }
      .error-msg { color: #d32f2f; font-size: 0.85rem; display: none; margin-top: -10px; margin-bottom: 5px; }

      button {
        padding: 12px 14px; cursor: pointer; background-color: #1976d2; margin-top: 10px;
        color: #fff; border: none; border-radius: 8px; font-size: 16px; transition: .2s; font-weight: bold;
      }
      button:hover { background-color: #125ca1; }
      button:disabled { background-color: #aaa; cursor: not-allowed; }

      .auto-wrap { position: relative; }
      .auto-menu {
        position: absolute; left: 0; right: 0; top: calc(100% + 4px);
        border: 1px solid #ddd; background: #fff; border-radius: 8px;
        box-shadow: 0 8px 24px rgba(0,0,0,.15);
        max-height: 200px; overflow: auto; z-index: 100;
      }
      .auto-item { padding: 10px 12px; cursor: pointer; font-size: 0.95rem; }
      .auto-item:hover, .auto-item.active { background: #e3f2fd; }

      #success-view { text-align: center; display: none; animation: fadeIn 0.5s; }
      .success-icon { font-size: 4rem; margin-bottom: 10px; display: block; }
      
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

      /* [æ–°å¢] è¿”å›æŒ‰éˆ•æ¨£å¼ */
      #back_img {
        position: absolute;
        height: 13%;
        left: 0;
        top: 0;
        cursor: pointer;
        z-index: 200;
      }
    </style>
  </head>

  <body>
    <!-- [æ–°å¢] è¿”å›æŒ‰éˆ•ï¼Œé€£çµåˆ°æ•™å¸«ç™»å…¥é  -->
    <img id="back_img" src="{{ url_for('static', filename='Font/1x/ALL_NAV_BAR_BACK.png') }}" onclick="window.location.href='/login/ta'">

    <div class="card">
      
      <div id="register-view">
        <h2>æ•™å¸«è¨»å†Š</h2>
        <form id="form">
          <div class="field">
            <label>å­¸æ ¡ (School)</label>
            <div class="auto-wrap" id="school-auto">
              <input id="school-input" placeholder="è«‹è¼¸å…¥å­¸æ ¡åç¨±æˆ–é—œéµå­—" autocomplete="off" required />
              <div class="auto-menu" id="school-menu" hidden></div>
            </div>
            <small style="margin-top:4px; display:block;">è‹¥æ¸…å–®ä¸­æ²’æœ‰æ‚¨çš„å­¸æ ¡ï¼Œå¯ç›´æ¥è¼¸å…¥å…¨åã€‚</small>
          </div>

          <div>
            <label>å¸³è™Ÿ (å­¸æ ¡ä¿¡ç®±)</label>
            <input id="account" type="email" placeholder="name@school.edu.tw" required />
          </div>

          <div>
            <label>å§“å</label>
            <input id="name" placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å" required />
          </div>

          <div>
            <label>å¯†ç¢¼</label>
            <input id="pwd" type="password" placeholder="è¨­å®šç™»å…¥å¯†ç¢¼" required />
          </div>

          <div>
            <label>ç¢ºèªå¯†ç¢¼</label>
            <input id="pwd_confirm" type="password" placeholder="è«‹å†æ¬¡è¼¸å…¥å¯†ç¢¼" required />
            <div class="error-msg" id="pwd-error">å…©æ¬¡è¼¸å…¥çš„å¯†ç¢¼ä¸ä¸€è‡´</div>
          </div>

          <button type="submit" id="submit-btn">è¨»å†Šå¸³è™Ÿ</button>
        </form>
      </div>

      <div id="success-view">
        <span class="success-icon">ğŸ‰</span>
        <h2 style="color: #2e7d32; margin-top: 0;">è¨»å†ŠæˆåŠŸ</h2>
        
        <p style="color:#555; line-height:1.6; font-size: 1.1rem;">
          æ­¡è¿åŠ å…¥ï¼æ‚¨çš„å¸³è™Ÿå·²å»ºç«‹å®Œæˆã€‚
        </p>
        
        <div style="background: #f1f8ff; padding: 15px; border-radius: 8px; color: #0d47a1; margin: 20px 0; text-align: left;">
            <strong>ä¸‹ä¸€æ­¥ï¼š</strong><br>
            è«‹ç™»å…¥ç³»çµ±ï¼Œä¸¦åœ¨ã€Œç­ç´šç®¡ç†ã€ä¸­å»ºç«‹æ‚¨çš„ç¬¬ä¸€å€‹ç­ç´šä¸¦å–å¾—ä»£ç¢¼ã€‚
        </div>
        
        <button onclick="goToHome()">å‰å¾€ç­ç´šç®¡ç†</button>
      </div>

    </div>

    <script>
      let targetUrl = "/ta/class_management";

      function debounce(fn, delay=150){ let t; return(...args)=>{clearTimeout(t); t=setTimeout(()=>fn(...args),delay);} }
      let SCHOOL_LIST=[];
      
      async function loadSchools(){
        try{
          const res=await fetch('/api/schools');
          const j=await res.json();
          if(j?.status==='success'&&Array.isArray(j.schools)) SCHOOL_LIST=j.schools;
        }catch(e){console.warn('å­¸æ ¡æ¸…å–®è¼‰å…¥å¤±æ•—',e);}
      }

      function setupSchoolAutocomplete(){
        const wrap=document.getElementById('school-auto');
        const input=document.getElementById('school-input');
        const menu=document.getElementById('school-menu');
        let currentIndex=-1;

        function renderMenu(items){
          menu.innerHTML=''; currentIndex=-1;
          if(!items.length){ menu.hidden=true; return; }
          items.forEach((s)=>{
            const div=document.createElement('div');
            div.className='auto-item';
            div.textContent = s.name; 
            div.addEventListener('mousedown',ev=>{
              ev.preventDefault(); input.value=s.name; menu.hidden=true;
            });
            menu.appendChild(div);
          });
          menu.hidden=false;
        }

        const filterAndShow=debounce(()=>{
          const kw=input.value.trim();
          if(!kw){ menu.hidden=true; return; }
          const result=SCHOOL_LIST.filter(s=>s.name.toLowerCase().includes(kw.toLowerCase())).slice(0,15);
          renderMenu(result);
        });

        input.addEventListener('input',filterAndShow);
        input.addEventListener('focus', filterAndShow);
        document.addEventListener('click',e=>{if(!wrap.contains(e.target)) menu.hidden=true;});
      }
      (async()=>{await loadSchools();setupSchoolAutocomplete();})();

      const pwd = document.getElementById('pwd');
      const pwdConfirm = document.getElementById('pwd_confirm');
      const pwdError = document.getElementById('pwd-error');

      pwdConfirm.addEventListener('input', () => {
        if(pwdConfirm.value && pwd.value !== pwdConfirm.value) {
            pwdConfirm.classList.add('error');
            pwdError.style.display = 'block';
        } else {
            pwdConfirm.classList.remove('error');
            pwdError.style.display = 'none';
        }
      });

      document.getElementById('form').addEventListener('submit', async e => {
        e.preventDefault();
        
        if(pwd.value !== pwdConfirm.value){
            alert('å…©æ¬¡è¼¸å…¥çš„å¯†ç¢¼ä¸ä¸€è‡´ï¼Œè«‹é‡æ–°ç¢ºèªã€‚');
            pwdConfirm.focus();
            return;
        }

        const school = document.getElementById('school-input').value.trim();
        const account = document.getElementById('account').value.trim();
        const name = document.getElementById('name').value.trim();

        if(!school || !account || !name || !pwd.value){
            alert('è«‹å®Œæ•´å¡«å¯«æ‰€æœ‰æ¬„ä½');
            return;
        }

        const btn = document.getElementById('submit-btn');
        btn.disabled = true;
        btn.textContent = 'è™•ç†ä¸­...';

        try {
            const res = await fetch('/register/ta',{
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({ 
                    school,
                    account, 
                    name, 
                    pwd: pwd.value 
                })
            });
            const j = await res.json();
            
            if(j.status === 'success'){
                document.getElementById('register-view').style.display = 'none';
                document.getElementById('success-view').style.display = 'block';
                // targetUrl = j.url; // å¦‚æœå¾Œç«¯æœ‰å›å‚³
            } else {
                alert(j.message || 'è¨»å†Šå¤±æ•—');
                btn.disabled = false;
                btn.textContent = 'è¨»å†Šå¸³è™Ÿ';
            }
        } catch(err) {
            console.error(err);
            alert('ç³»çµ±é€£ç·šéŒ¯èª¤');
            btn.disabled = false;
            btn.textContent = 'è¨»å†Šå¸³è™Ÿ';
        }
      });

      function goToHome(){ location.href = targetUrl; }
    </script>
  </body>
</html>