<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8"/>
    <title>學生註冊</title>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <style>
      body {
        margin: 0; padding: 0; height: 100vh; width: 100vw;
        display: flex; align-items: center; justify-content: center;
        background: url("{{ url_for('static', filename='Font/1x/ALL_BG_LOG_IN_STUDENT.png') }}") 
                    no-repeat center center fixed;
        background-color: #f0f2f5;
        background-size: cover;
        font-family: system-ui, -apple-system, "Noto Sans TC", Arial;
      }
      .card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 16px; padding: 30px 40px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        max-width: 520px; width: 90%;
        position: relative;
        z-index: 10;
      }
      h2 { text-align: center; margin-bottom: 20px; color: #333; }
      form { display: grid; gap: 14px; }
      label { font-weight: 600; color: #222; font-size: 0.95rem; margin-bottom: 4px; display:block;}

      select, input {
        padding: 10px; width: 100%; box-sizing: border-box;
        border: 1px solid #ccc; border-radius: 6px; font-size: 1rem;
        transition: border 0.2s;
      }
      input:focus, select:focus { border-color: #1976d2; outline: none; }
      
      input.error { border-color: #d32f2f; background-color: #fff8f8; }
      .error-text { color: #d32f2f; font-size: 0.85rem; display: none; margin-top:-10px; }

      .row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }

      button {
        padding: 12px 14px; margin-top: 10px; cursor: pointer;
        background-color: #1976d2; color: white; border: none;
        border-radius: 8px; font-size: 16px; font-weight: bold; transition: 0.2s;
      }
      button:hover { background-color: #125ca1; }
      button:disabled { background-color: #aaa; }

      hr { width: 100%; border: 0; border-top: 1px solid #eee; margin: 10px 0; }

      #invite_code {
        text-transform: uppercase; letter-spacing: 2px; font-weight: bold;
        color: #d32f2f; background-color: #fffbfb; border: 2px solid #ffcdd2;
      }
      #invite_code:focus { border-color: #d32f2f; }

      /* [新增] 返回按鈕樣式 (參考登入頁面) */
      #back_img {
        position: absolute;
        height: 13%; /* 配合登入頁面的比例 */
        left: 0;
        top: 0;
        cursor: pointer;
        z-index: 200;
      }
    </style>
  </head>

  <body>
    <!-- [新增] 返回按鈕 -->
    <img id="back_img" src="{{ url_for('static', filename='Font/1x/ALL_NAV_BAR_BACK.png') }}" onclick="window.location.href='/login/stu'">

    <div class="card">
      <h2>學生註冊</h2>
      <form id="form">
        
        <div>
          <label>班級代碼 (請向老師索取)</label>
          <input id="invite_code" type="text" placeholder="例如：A1B2C3" required />
        </div>

        <div class="row">
            <div>
              <label>年級</label>
              <select id="grade" required>
                <option value="">請選擇</option>
                <option value="1">1年</option>
                <option value="2">2年</option>
                <option value="3">3年</option>
                <option value="4">4年</option>
                <option value="5">5年</option>
                <option value="6">6年</option>
              </select>
            </div>
            <div>
              <label>班級</label>
              <select id="clazz" required></select>
            </div>
            <div>
              <label>座號</label>
              <select id="seat_no" required></select>
            </div>
        </div>

        <div>
          <label>姓名</label>
          <input id="name" placeholder="請輸入真實姓名" required />
        </div>

        <hr>

        <div>
          <label>帳號 (Email信箱)</label>
          <input id="account" type="email" placeholder="example@email.com" required />
        </div>

        <div>
          <label>密碼</label>
          <input id="pwd" type="password" required />
        </div>

        <div>
          <label>確認密碼</label>
          <input id="pwd_confirm" type="password" placeholder="請再次輸入密碼" required />
          <div class="error-text" id="pwd-error">密碼不一致</div>
        </div>

        <button type="submit" id="submit-btn">確認註冊</button>
      </form>
    </div>

    <script>
      const grade   = document.getElementById('grade');
      const clazz   = document.getElementById('clazz');
      const seat    = document.getElementById('seat_no');
      const pwd     = document.getElementById('pwd');
      const pwdConf = document.getElementById('pwd_confirm');
      const pwdErr  = document.getElementById('pwd-error');

      function fillClazz(max=20) {
        clazz.innerHTML = '<option value="">請選擇</option>';
        for (let i=1;i<=max;i++){
          const opt = document.createElement('option');
          opt.value = String(i).padStart(2, '0');
          opt.textContent = i + ' 班';
          clazz.appendChild(opt);
        }
      }
      function fillSeat(max=50){
        seat.innerHTML = '<option value="">請選擇</option>';
        for (let i=1;i<=max;i++){
          const opt = document.createElement('option');
          opt.value = String(i);
          opt.textContent = i + ' 號';
          seat.appendChild(opt);
        }
      }
      fillClazz(20);
      fillSeat(50);

      pwdConf.addEventListener('input', () => {
        if (pwdConf.value && pwd.value !== pwdConf.value) {
            pwdConf.classList.add('error');
            pwdErr.style.display = 'block';
        } else {
            pwdConf.classList.remove('error');
            pwdErr.style.display = 'none';
        }
      });

      document.getElementById('form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const code = document.getElementById('invite_code').value.trim();
        const acc  = document.getElementById('account').value.trim();
        const name = document.getElementById('name').value.trim();
        const g    = grade.value;
        const c    = clazz.value;
        const s    = seat.value;

        if (pwd.value !== pwdConf.value) {
            alert('兩次輸入的密碼不一致！');
            pwdConf.focus();
            return;
        }
        if (!code || !acc || !name || !g || !c || !s) {
            alert('請完整填寫所有欄位');
            return;
        }

        const btn = document.getElementById('submit-btn');
        btn.disabled = true;
        btn.textContent = '註冊中...';

        try {
          const res = await fetch('/register/stu', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({
              code: code,
              account: acc,
              pwd: pwd.value, 
              name: name,
              grade: g,
              clazz: c,
              seat_no: s
            })
          });

          const j = await res.json();
          if (j.status === 'success') {
            alert('註冊成功！即將進入首頁。');
            location.href = j.url;
          } else {
            alert(j.message || '註冊失敗');
            btn.disabled = false;
            btn.textContent = '確認註冊';
          }
        } catch(err) {
          console.error(err);
          alert('系統錯誤，請稍後再試');
          btn.disabled = false;
          btn.textContent = '確認註冊';
        }
      });
    </script>
  </body>
</html>